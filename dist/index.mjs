var s=class s{constructor(e){this.bandwidthBuffer=[];this.bandwidthObserver=null;this.bandwidthIntervalId=null;if(!e.projectId)throw new Error("BlipLogs: projectId is required");let t=typeof window<"u";this.isBrowser=t,this.publicKey=e.publicKey??e.projectId;let r=e.secretKey??e.apiKey;this.secretKey=t?void 0:r??void 0,this.projectId=e.projectId,this.debug=e.debug??!1,!t&&!r&&this.debug&&console.warn("BlipLogs: No secretKey provided on server. Events will be sent without server auth. This is expected during SSR pre-render; for dedicated server-side tracking, provide a secretKey."),this.onError=e.onError,this.privacy={anonymizeIp:e.privacy?.anonymizeIp??!1,collectUrl:e.privacy?.collectUrl??!0,collectReferrer:e.privacy?.collectReferrer??!0,collectUserAgent:e.privacy?.collectUserAgent??!0,collectSessionId:e.privacy?.collectSessionId??!0};let i=e.trackBandwidth===!0||typeof e.trackBandwidth=="object"&&e.trackBandwidth.enabled!==!1;this.bandwidthConfig={enabled:i,batchInterval:typeof e.trackBandwidth=="object"?e.trackBandwidth.batchInterval??3e4:3e4,resourceTypes:typeof e.trackBandwidth=="object"?e.trackBandwidth.resourceTypes??[]:[],maxBatchSize:typeof e.trackBandwidth=="object"?e.trackBandwidth.maxBatchSize??100:100,sanitizeUrls:typeof e.trackBandwidth=="object"?e.trackBandwidth.sanitizeUrls??!0:!0},this.bandwidthConfig.enabled&&this.initBandwidthTracking()}static configure(e){s.globalInstance=new s(e)}static getInstance(){if(!s.globalInstance)throw new Error("BlipLogs: Global instance not configured. Call BlipLogs.configure() first.");return s.globalInstance}static track(e,t,r="info"){return s.getInstance().track(e,t,r)}static info(e,t){return s.getInstance().info(e,t)}static warn(e,t){return s.getInstance().warn(e,t)}static error(e,t){return s.getInstance().error(e,t)}getSessionId(){if(typeof window>"u"||typeof sessionStorage>"u")return;let e=1800*1e3,t="blip_session_id",r="blip_session_ts";try{let i=sessionStorage.getItem(t),o=sessionStorage.getItem(r),n=o?parseInt(o,10):null,a=Date.now();return(!i||!n||a-n>e)&&(i=crypto.randomUUID(),sessionStorage.setItem(t,i)),sessionStorage.setItem(r,a.toString()),i}catch{return}}sanitizeUrl(e){if(e)try{let t=new URL(e),r=t.searchParams,i=new Set(s.SENSITIVE_PARAMS.map(n=>n.toLowerCase())),o=[];r.forEach((n,a)=>{i.has(a.toLowerCase())&&o.push(a)});for(let n of o)r.set(n,"[REDACTED]");return t.toString()}catch{let t=e.indexOf("?");return t!==-1?e.substring(0,t)+"?[QUERY_REDACTED]":e}}parseUserAgent(e){let t={browser:"Unknown",browserVersion:"",os:"Unknown",isBot:!1,deviceType:"unknown",raw:e};if(!e)return t;for(let{pattern:r,name:i}of s.BOT_PATTERNS)if(r.test(e))return t.isBot=!0,t.botName=i,t.browser=i,t;if(/edg/i.test(e)){t.browser="Edge";let r=e.match(/edg[e]?\/(\d+[\d.]*)/i);t.browserVersion=r?.[1]||""}else if(/opr|opera/i.test(e)){t.browser="Opera";let r=e.match(/(?:opr|opera)[\/\s](\d+[\d.]*)/i);t.browserVersion=r?.[1]||""}else if(/chrome|chromium|crios/i.test(e)){t.browser="Chrome";let r=e.match(/(?:chrome|chromium|crios)\/(\d+[\d.]*)/i);t.browserVersion=r?.[1]||""}else if(/firefox|fxios/i.test(e)){t.browser="Firefox";let r=e.match(/(?:firefox|fxios)\/(\d+[\d.]*)/i);t.browserVersion=r?.[1]||""}else if(/safari/i.test(e)&&!/chrome/i.test(e)){t.browser="Safari";let r=e.match(/version\/(\d+[\d.]*)/i);t.browserVersion=r?.[1]||""}else if(/msie|trident/i.test(e)){t.browser="Internet Explorer";let r=e.match(/(?:msie |rv:)(\d+[\d.]*)/i);t.browserVersion=r?.[1]||""}return/windows/i.test(e)?(t.os="Windows",/windows nt 10/i.test(e)?t.os="Windows 10/11":/windows nt 6.3/i.test(e)?t.os="Windows 8.1":/windows nt 6.2/i.test(e)?t.os="Windows 8":/windows nt 6.1/i.test(e)&&(t.os="Windows 7")):/macintosh|mac os x/i.test(e)?t.os="macOS":/iphone/i.test(e)?t.os="iOS":/ipad/i.test(e)?t.os="iPadOS":/android/i.test(e)?t.os="Android":/linux/i.test(e)?t.os="Linux":/cros/i.test(e)&&(t.os="Chrome OS"),/mobile|iphone|ipod|android.*mobile|webos|blackberry|opera mini|opera mobi|iemobile/i.test(e)?t.deviceType="mobile":/tablet|ipad|android(?!.*mobile)|kindle|silk/i.test(e)?t.deviceType="tablet":/windows|macintosh|linux|cros/i.test(e)&&(t.deviceType="desktop"),t}getContext(){let e={projectId:this.projectId};return typeof window>"u"?e:{...e,url:this.privacy.collectUrl?this.sanitizeUrl(window.location?.href):void 0,referrer:this.privacy.collectReferrer&&this.sanitizeUrl(document.referrer)||void 0,userAgent:this.privacy.collectUserAgent?navigator.userAgent:void 0}}track(e,t,r="info"){if(!e)return console.warn("BlipLogs: event name is required"),!1;let i=Date.now(),o=this.privacy.collectSessionId?this.getSessionId():void 0,n={event:e,level:r,metadata:t,context:this.getContext(),timestamp:new Date().toISOString(),session_id:o,timestamp_ms:i,anonymize_ip:this.privacy.anonymizeIp||void 0};return this.send(n)}info(e,t){return this.track(e,t,"info")}warn(e,t){return this.track(e,t,"warn")}error(e,t){return this.track(e,t,"error")}getAuthHeaders(){let e={"Content-Type":"application/json","X-Blip-Public-Key":this.publicKey};return!this.isBrowser&&this.secretKey&&(e["X-Blip-Secret-Key"]=this.secretKey),e}send(e){let t={...e,project_id:this.projectId},r=JSON.stringify(t);if(typeof fetch<"u")return this.sendWithFetch(r,s.API_ENDPOINT);if(typeof navigator<"u"&&navigator.sendBeacon)try{let i=new URL(s.API_ENDPOINT);i.searchParams.set("publicKey",this.publicKey);let o=new Blob([r],{type:"application/json"}),n=navigator.sendBeacon(i.toString(),o);return n&&this.debug&&console.warn("BlipLogs: Using sendBeacon fallback; custom headers (e.g. API key) are not sent. Public key was passed via query. Ensure domain whitelisting is configured for browser usage."),n}catch{return this.handleError({type:"network",message:"sendBeacon failed"}),!1}return this.handleError({type:"unknown",message:"No suitable transport available (fetch and sendBeacon unavailable)"}),!1}handleError(e){if(this.debug&&console.error(`BlipLogs Error [${e.type}]:`,e.message,e),this.onError)try{this.onError(e)}catch(t){this.debug&&console.error("BlipLogs: Error in onError callback:",t)}}sendWithFetch(e,t=s.API_ENDPOINT){try{let r=this.getAuthHeaders();return fetch(t,{method:"POST",headers:r,body:e,keepalive:!0,credentials:"omit"}).then(i=>{if(!i.ok){let o="unknown",n=`HTTP ${i.status}`;i.status===429?(o="rate_limit",n="Monthly event limit exceeded. Upgrade your plan to continue."):i.status===401?(o="auth",n="Invalid API key"):i.status===403?(o="auth",n="Origin not allowed for this project"):i.status===400&&(o="validation",n="Invalid request payload"),this.handleError({type:o,message:n,statusCode:i.status})}}).catch(i=>{this.handleError({type:"network",message:i?.message||"Network request failed",originalError:i instanceof Error?i:void 0})}),!0}catch(r){return this.handleError({type:"network",message:r instanceof Error?r.message:"Request failed",originalError:r instanceof Error?r:void 0}),!1}}initBandwidthTracking(){if(typeof window>"u"||typeof PerformanceObserver>"u"){this.debug&&console.warn("BlipLogs: Bandwidth tracking requires browser environment with PerformanceObserver");return}try{this.bandwidthObserver=new PerformanceObserver(e=>{for(let t of e.getEntries())t.entryType==="resource"&&this.recordResourceTiming(t)}),this.bandwidthObserver.observe({type:"resource",buffered:!0}),this.bandwidthIntervalId=setInterval(()=>{this.flushBandwidthBatch()},this.bandwidthConfig.batchInterval),typeof document<"u"&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&this.flushBandwidthBatch()}),this.debug&&console.log("BlipLogs: Bandwidth tracking initialized")}catch(e){this.debug&&console.error("BlipLogs: Failed to initialize bandwidth tracking:",e)}}recordResourceTiming(e){let t=e.initiatorType||"other";if(this.bandwidthConfig.resourceTypes.length>0&&!this.bandwidthConfig.resourceTypes.includes(t))return;let i={url:this.bandwidthConfig.sanitizeUrls?this.sanitizeResourceUrl(e.name):e.name,resourceType:t,transferSize:e.transferSize||0,encodedBodySize:e.encodedBodySize||0,decodedBodySize:e.decodedBodySize||0,duration:e.duration||0,startTime:e.startTime||0};this.bandwidthBuffer.push(i),this.bandwidthBuffer.length>=this.bandwidthConfig.maxBatchSize&&this.flushBandwidthBatch()}sanitizeResourceUrl(e){let t=this.sanitizeUrl(e);if(!t)return"[UNKNOWN]";try{let r=new URL(t);return r.origin+r.pathname}catch{return t}}flushBandwidthBatch(){if(this.bandwidthBuffer.length===0)return;let e=this.bandwidthBuffer.splice(0,this.bandwidthConfig.maxBatchSize),t=e.reduce((n,a)=>n+a.transferSize,0),r=typeof navigator<"u"?navigator.userAgent:"",i=this.privacy.collectUserAgent&&r?this.parseUserAgent(r):void 0,o={resources:e,session_id:this.privacy.collectSessionId?this.getSessionId():void 0,timestamp_ms:Date.now(),project_id:this.projectId,context:this.getContext(),totalTransferSize:t,resourceCount:e.length,userAgent:i};this.sendBandwidth(o)}sendBandwidth(e){let t=`${s.API_ENDPOINT}/bandwidth`,r=JSON.stringify(e);if(typeof fetch<"u")return this.sendWithFetch(r,t);if(typeof navigator<"u"&&navigator.sendBeacon)try{let i=new URL(t);i.searchParams.set("publicKey",this.publicKey);let o=new Blob([r],{type:"application/json"}),n=navigator.sendBeacon(i.toString(),o);return n&&this.debug&&console.warn("BlipLogs: Bandwidth sent via sendBeacon fallback; custom headers not sent. Public key in query."),n}catch{return this.handleError({type:"network",message:"Bandwidth sendBeacon failed"}),!1}return!1}stopBandwidthTracking(){this.bandwidthObserver&&(this.bandwidthObserver.disconnect(),this.bandwidthObserver=null),this.bandwidthIntervalId&&(clearInterval(this.bandwidthIntervalId),this.bandwidthIntervalId=null),this.flushBandwidthBatch(),this.debug&&console.log("BlipLogs: Bandwidth tracking stopped")}static stopBandwidthTracking(){s.getInstance().stopBandwidthTracking()}};s.globalInstance=null,s.API_ENDPOINT="https://api.bliplogs.co.uk",s.SENSITIVE_PARAMS=["token","access_token","refresh_token","id_token","apikey","api_key","api-key","key","password","pwd","pass","secret","auth","authorization","bearer","session","sessionid","session_id","code","state","nonce","email","phone","ssn","credit_card","cc","cvv","card"],s.BOT_PATTERNS=[{pattern:/googlebot/i,name:"Googlebot"},{pattern:/bingbot/i,name:"Bingbot"},{pattern:/slurp/i,name:"Yahoo Slurp"},{pattern:/duckduckbot/i,name:"DuckDuckBot"},{pattern:/baiduspider/i,name:"Baiduspider"},{pattern:/yandexbot/i,name:"YandexBot"},{pattern:/facebot|facebookexternalhit/i,name:"Facebook Bot"},{pattern:/twitterbot/i,name:"Twitter Bot"},{pattern:/linkedinbot/i,name:"LinkedIn Bot"},{pattern:/slackbot/i,name:"Slackbot"},{pattern:/telegrambot/i,name:"Telegram Bot"},{pattern:/discordbot/i,name:"Discord Bot"},{pattern:/whatsapp/i,name:"WhatsApp"},{pattern:/applebot/i,name:"Applebot"},{pattern:/semrushbot/i,name:"SEMrush Bot"},{pattern:/ahrefsbot/i,name:"Ahrefs Bot"},{pattern:/mj12bot/i,name:"Majestic Bot"},{pattern:/dotbot/i,name:"DotBot"},{pattern:/petalbot/i,name:"PetalBot"},{pattern:/bytespider/i,name:"ByteSpider"},{pattern:/gptbot/i,name:"GPTBot"},{pattern:/claudebot/i,name:"ClaudeBot"},{pattern:/headless/i,name:"Headless Browser"},{pattern:/phantomjs/i,name:"PhantomJS"},{pattern:/lighthouse/i,name:"Lighthouse"},{pattern:/pagespeed/i,name:"PageSpeed Insights"},{pattern:/crawl|spider|bot|scrape/i,name:"Generic Bot"}];var d=s,c=d;export{d as BlipLogs,c as default};
